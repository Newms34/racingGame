"use strict";var socket=io(),app=angular.module("raceApp",[]);app.controller("create-cont",["$scope","userFact","$http",function(e,t,o){e.trackBlurbs=[],t.chkLog().then(function(o){"no"==o?window.location.href="./login":(e.user=o,t.getTrackBlurbs().then(function(t){e.trackBlurbs=t,e.trackPick=e.trackBlurbs[0].id}))}),e.maxNum=0,e.makeGame=function(){if(e.pwd&&e.pwd!=e.pwdDup||!e.name||!e.name.length)return bootbox.alert("It looks like there's a problem with your submission. Please check to make sure you've included a name, and that both password fields (if included) are the same!"),!1;var t={user:e.user.name,track:e.trackPick,"protected":!!e.pwd,players:[e.user.name],maxPlayers:e.maxNum,name:e.name,id:Math.floor(9999999*Math.random()).toString(32)};e.pwd&&(t.pass=e.pwd),socket.emit("newGame",t)}}]),app.controller("edit-cont",["$scope","pathFact","userFact",function(e,t,o){e.w=10,e.h=10,e.rows=[],e.path=[],o.chkLog().then(function(t){"no"==t?window.location.href="./login.html":e.user=t}),e.startMade=!1,e.roadTypes=[{num:1,lbl:"normal",symb:" ",desc:"Normal roads are, well, normal. They just let you drive right on past!"},{num:2,lbl:"boost",symb:"▶",desc:"Boosts give you a little extra bit of speed, but take a while to respawn!"},{num:3,lbl:"random",symb:"�",desc:"A mixed bag! Random blocks can either help you or hinder you!"},{num:4,lbl:"slow",symb:"▒",desc:"Be careful of these! Hitting slow blocks not only lowers your speed, but also removes it temporarily for other racers!"}],e.drawCells=function(){e.rows=[],e.path=[];for(var t=0;t<e.h;t++){for(var o={cells:[]},n=0;n<e.w;n++)o.cells.push({x:n,y:t,cellType:0});e.rows.push(o)}e.startMade=!1},e.pathDone=!1,e.drawCells(),e.processCell=function(o,n){if(1==n.which)if(e.startMade){var r=e.path[e.path.length-1];o.cellType||e.pathDone?o.x==r.x&&o.y==r.y&&(e.path.pop(),o.cellType=0,e.pathDone=!1,e.path.length||(e.startMade=!1)):(1==Math.abs(r.x-o.x)&&r.y==o.y||1==Math.abs(r.y-o.y)&&r.x==o.x)&&(console.log("cell adjacent to prev cell"),o.cellType=1,e.path.push({x:o.x,y:o.y}),t.checkEnd(o,r,e.path)&&(console.log("path auto-closed"),e.pathDone=!0))}else e.startMade=!0,o.cellType=1,e.path.push({x:o.x,y:o.y});else 3==n.which&&o.cellType&&(e.pickCellType=!0,e.cellBeingEdited=o,e.$digest(),e.drawCells())},e.pickRoadType=function(t){e.cellBeingEdited.cellType=t,e.cellBeingEdited=null,e.pickCellType=!1},e.save=function(){return e.name&&e.desc?void bootbox.confirm("Are you sure you want to save this track?",function(o){o&&null!=o&&t.prepareForSave(e.name,e.desc,e.path,e.rows,e.w,e.h).then(function(t){t&&(e.path=[],e.pathDone=!1,e.cellBeingEdited=null)})}):(bootbox.alert("Please give your track a name and description!"),!1)},e.getCellRads=function(t){for(var o,n,r=0;r<e.path.length;r++)if(e.path[r].x==t.x&&e.path[r].y==t.y){if(r&&r<e.path.length-1?(o=e.path[r-1],n=e.path[r+1]):r?(o=e.path[r-1],n=e.path[0]):(o=e.path[e.path.length-1],n=e.path[r+1]),console.log("bef",o,"aft",n,"curr",e.path[r]),o.x<t.x&&o.y==t.y)return n.y<t.y&&n.x==t.x?"0 0 100% 0":n.y>t.y&&n.x==t.x?"0 100% 0 0":"0 0 0 0";if(o.x>t.x&&o.y==t.y)return n.y<t.y&&n.x==t.x?"0 0 0 100%":n.y>t.y&&n.x==t.x?"100% 0 0 0":"0 0 0 0";if(o.y<t.y&&o.x==t.x)return n.x<t.x&&n.y==t.y?"0 0 100% 0":n.x>t.x&&n.y==t.y?"0 0 0 100%":"0 0 0 0";if(o.y>t.y&&o.x==t.x)return n.x<t.x&&n.y==t.y?"0 100% 0 0":n.x>t.x&&e.path[r+1].y==t.y?"100% 0 0 0":"0 0 0 0"}}}]),app.controller("join-cont",["$scope","$http","userFact",function(e,t,o){e.getGames=function(){socket.emit("getGames",{x:null})},o.chkLog().then(function(t){"no"==t?window.location.href="./login":(e.user=t,e.getGames())}),e.getRemSlots=function(e){return new Array(e.maxPlayers-e.players.length)},socket.on("allGames",function(t){console.log("games",t.all),e.games=t.all,e.$digest()}),e.joinGame=function(t){bootbox.confirm({title:"Join Game",message:t["protected"]?"This game is protected. Please enter the password if you wish to join<br/><input id='gamepwd'>":"Are you sure you want to join this game?",buttons:{confirm:{label:"Join",className:"btn-success",callback:function(){socket.emit("attemptJoin",{game:t,pwd:t["protected"]?$("#gamepwd").val():null,user:e.user.name})}},cancel:{label:"Cancel",className:"btn-danger"}}})}}]),app.controller("log-con",["$scope","$http","$q","$timeout","$window","userFact",function(e,t,o,n,r,a){e.hazLogd=!1,e.musOn=!0,e.user={prof:"0"},e.newUsr=function(){if(e.regForm.pwd.$viewValue!=e.regForm.pwdTwo.$viewValue)bootbox.alert("Your passwords don&rsquo;t match!",function(){});else{var o={user:e.regForm.username.$viewValue,password:e.regForm.pwd.$viewValue,prof:e.user.prof+1};console.log("userInf",o),t.post("/user/new",o).then(function(t){"saved!"==t.data&&e.login(!0)})}},e.passMatch=!0,e.passStr=0,e.isNew=!1,e.checkPwdStr=function(){e.regForm.pwd.$viewValue&&(e.passStr=a.checkPwdStr(e.regForm.pwd.$viewValue)),console.log("pwd strength",e.passStr)},e.checkPwds=function(){e.passMatch=a.checkPwdMatch(e.regForm.pwd.$viewValue,e.regForm.pwdTwo.$viewValue)},e.dupName=!1,e.nameCheck=function(){var t=e.regForm.username.$viewValue;console.log("userFact",a.checkName,"name",t),a.checkName(t).then(function(t){e.dupName=t})},e.login=function(t){t?a.login({name:e.regForm.username.$viewValue,pwd:e.regForm.pwd.$viewValue}).then(function(t){t?(e.hazLogd=!0,e.getNews()):bootbox.alert("Either your username or password is not correct!")}):a.login({name:e.logForm.username.$viewValue,pwd:e.logForm.pwd.$viewValue}).then(function(t){t?(e.hazLogd=!0,e.getNews()):bootbox.alert("Either your username or password is not correct!")})},e.play=function(){r.location.href="./"},e.passInf=function(){bootbox.alert('<h3>Password Strength</h3><hr/>Here are a few things to include for a stronger password:<ul><li>A lowercase letter</li><li>An uppercase letter</li><li>A number</li><li>A non alpha-numeric symbol (something like "@" or "$")</li></ul>Longer passwords are also generally better!')},e.checkPwdStr=function(){e.regForm.pwd.$viewValue&&(e.passStr=a.checkPwdStr(e.regForm.pwd.$viewValue)),console.log("pwd strength",e.passStr)},e.upd=[],e.parseInt=parseInt}]),app.controller("nav-cont",["$scope","userFact","$window",function(e,t,o){e.navButs=[{text:"Map Editor",url:"edit"},{text:"Create a Race",url:"create"},{text:"Join a Race",url:"join"}],e.getLoc=function(e){return window.location.href.slice(window.location.href.lastIndexOf("/")+1)==e},$(window).scrollTop(0),e.getLoc()}]),app.factory("pathFact",["$http",function(e){var t=function(e){for(var t=(document.querySelector("#race-field"),[]),o=[],n=0;n<e.cells.length;n++)o.push(e.cells[n]),o.length==e.width&&(t.push(o),o=[]);return t};return{checkEnd:function(e,t,o){for(var n=0;n<o.length;n++)if(console.log("examing cells\nCurrent: ",e,"\nprev: ",t,"\ncell: ",o[n]),(1==Math.abs(e.x-o[n].x)&&e.y==o[n].y||1==Math.abs(e.y-o[n].y)&&e.x==o[n].x)&&(o[n].x!=t.x||o[n].y!=t.y))return!0;return!1},prepareForSave:function(t,o,n,r,a,l){for(var c={name:t,desc:o,width:a,height:l,id:Math.floor(999999999*Math.random()).toString(32),cells:[]},s=0;s<a;s++)for(var i=0;i<l;i++){for(var u={x:s,y:i,next:null,cellType:r[i].cells[s].cellType},p=0;p<n.length;p++)n[p].x==s&&n[p].y==i&&(console.log("foundpathcell"),n[p+1]?u.next=n[p+1].x+"-"+n[p+1].y:u.next=n[0].x+"-"+n[0].y);c.cells.push(u)}return console.log("NEW TRACK",c),e.post("/track/new",c).then(function(e){return"err"==e.data?(bootbox.alert("There was a problem saving the track "+t+"! Sorry!"),!1):(bootbox.alert("Track "+t+" has been saved!"),!0)})},getTrack:function(o){return e.get("/track/get/"+o).then(function(e){return"err"==e.data?(bootbox.alert("There was a problem retrieving the track "+name+"!"),!1):t(e.data)})}}}]),app.controller("race-cont",["$scope","userFact",function(e,t){t.chkLog().then(function(t){"no"==t?window.location.href="./login":e.user=t})}]),app.factory("userFact",["$http",function(e){return{chkLog:function(){return e.get("/user/check").then(function(e){return e.data})},checkPwdStr:function(e){console.log("password:",e);var t=new RegExp("[A-Z]","g"),o=new RegExp("[a-z]","g"),n=new RegExp("[0-9]","g"),r=new RegExp("\\W","g"),a=0;e.search(t)!=-1&&a++,e.search(o)!=-1&&a++,e.search(n)!=-1&&a++,e.search(r)!=-1&&a++;var l=e.length;return l>16?a+=6:l>11?a+=4:l>6&&(a+=2),a},checkPwdMatch:function(e,t){return e==t},checkName:function(t){return console.log("NAME TO BACKEND",t),e.get("/user/nameOkay/"+t).then(function(e){return console.log("NAME RESPONSE:",e.data),"okay"!=e.data})},login:function(t){return console.log("credentials in factory",t),e.post("/user/login",t).then(function(e){return console.log("response from backend:",e),"yes"==e.data})},checkLogin:function(){return e.get("/user/chkLog").then(function(e){return console.log("CHECKLOG RESULTS",e),e.data})},getTrackBlurbs:function(){return e.get("/track/getBlurbs").then(function(e){return e.data})}}}]);